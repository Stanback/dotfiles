#!/usr/bin/env bash
set -euo pipefail

# --- Settings ---------------------------------------------------------------
REPO="${REPO:-$HOME/dotfiles}"
BREWFILE="$REPO/Brewfile"

# --- Colors -----------------------------------------------------------------
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# --- Helpers ----------------------------------------------------------------
info() { echo -e "${GREEN}==>${NC} $1"; }
warn() { echo -e "${YELLOW}==>${NC} $1"; }
error() { echo -e "${RED}==>${NC} $1"; }

# --- Preflight --------------------------------------------------------------
info "Package installation script"

# Check if Brewfile exists
if [[ ! -f "$BREWFILE" ]]; then
  error "Brewfile not found at $BREWFILE"
  exit 1
fi

# --- Install Homebrew if needed ---------------------------------------------
if ! command -v brew >/dev/null 2>&1; then
  warn "Homebrew not installed"
  read -p "Install Homebrew now? (y/N) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    info "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for Apple Silicon Macs
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
      eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
  else
    error "Homebrew is required. Install from: https://brew.sh"
    exit 1
  fi
fi

# --- Install packages -------------------------------------------------------
info "Installing packages from Brewfile..."
brew bundle install --file="$BREWFILE"

# --- Update existing packages -----------------------------------------------
read -p "Update existing packages? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  info "Updating packages..."
  brew update
  brew upgrade
fi

# --- Cleanup ----------------------------------------------------------------
read -p "Clean up unused packages? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  info "Cleaning up..."
  brew bundle cleanup --file="$BREWFILE"
  brew cleanup
fi

# --- Post-install tips ------------------------------------------------------
info "Done!"
echo ""
echo "Next steps:"
echo "  • Some packages may require shell restart: exec zsh"
echo "  • GCloud SDK: run 'gcloud init' to authenticate"
echo "  • Configure Neovim plugins: run 'nvim' and :Lazy sync"
echo ""
echo "Package management commands:"
echo "  • Install packages:     brew bundle install"
echo "  • Update Brewfile:      brew bundle dump --force"
echo "  • Cleanup unused:       brew bundle cleanup"
echo "  • Check for issues:     brew doctor"
